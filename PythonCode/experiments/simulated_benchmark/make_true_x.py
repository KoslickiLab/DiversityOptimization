import subprocess
import numpy as np


def make_true_x(metagenome, reference):

    bbmap_dir = "bbmap"  # location of bbmap

    subprocess.run(
        f"bash {bbmap_dir}/bbmap.sh in={metagenome} ref={reference} out=/dev/null covstats=covstats.txt "
        f"twocolumn=t", shell=True, stdout=subprocess.DEVNULL)

    ## Get table generated by bbmap
    covstats = np.genfromtxt("covstats.txt", dtype=str, delimiter='\t', skip_header=1)

    ids = list(covstats[:, 0])  # Sequence ids (first column of covstats)

    # create normalized, unordered x from second column of covstats
    unordered_x = np.array(list(map(float, covstats[:, 1])))
    unordered_x = unordered_x / sum(unordered_x)

    ## Create list with each index representing the population of each sequence id
    x = list()
    with open(reference, 'r') as file:
        for line in file:
            if line[0] == '>':
                loc = ids.index(line[1:-1])
                x.append(unordered_x[loc])

    ## Normalize x to represent population proportions
    return np.array(x)
